{% extends "base.html" %}

{% block head_styles %}
<style>
    /* These styles are specific to the index page and can be moved to ocean_adventure.css */
    input[type=text] { width: 80%; padding: 10px; margin: 10px 0; border-radius: 4px; border: 1px solid #ccc; }
    input[type=submit] { background-color: #1c4587; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; }
    #install-button { display: none; background-color: #38761d; margin-top: 15px; } /* Hidden by default */
</style>
{% endblock %}

{% block content %}
    <div class="container">
        <div class="title-block">
            <div class="logo">
                <img src="{{ url_for('static', filename='image.png') }}" alt="Ocean Adventure Fish Logo">
            </div>
            <h2>Ocean Adventure</h2>
        </div>
        
        <p class="tagline">Dive into the fun and explore the deep blue sea!</p>

        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="flash {{ category }}">{{ message }}</div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        <div class="start-form">
            <p>Enter your name to start your exciting voyage.</p>
            <form method="post">
                <input type="text" name="player_name" placeholder="Your Explorer Name" required>
                <br>
                <input type="submit" value="Start Adventure!">
            </form>
        </div>

        <hr style="margin-top: 30px;">
        <button id="install-button" class="flash" style="cursor: pointer; font-size: 1em; border: none;">Install Ocean Adventure App</button>
        <p><a href="{{ url_for('leaderboard') }}">View the Deep Sea Leaderboard</a></p>
    </div>
{% endblock %}

{% block scripts %}
<script>
    // Register the service worker to make the app installable
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register("{{ url_for('static', filename='service-worker.js') }}")
            .then((registration) => {
                console.log('Service Worker registered with scope:', registration.scope);
            }).catch((error) => {
                console.error('Service Worker registration failed:', error);
            });
    }

    // Logic to control the PWA installation prompt
    let deferredPrompt;
    const installButton = document.getElementById('install-button');

    window.addEventListener('beforeinstallprompt', (e) => {
        // Prevent the mini-infobar from appearing on mobile
        e.preventDefault();
        // Stash the event so it can be triggered later.
        deferredPrompt = e;
        // Update UI to notify the user they can install the PWA
        installButton.style.display = 'block';

        installButton.addEventListener('click', () => {
            // Hide our user interface that shows our A2HS button
            installButton.style.display = 'none';
            // Show the prompt
            deferredPrompt.prompt();
            // Wait for the user to respond to the prompt
            deferredPrompt.userChoice.then((choiceResult) => {
                if (choiceResult.outcome === 'accepted') {
                    console.log('User accepted the install prompt');
                }
                deferredPrompt = null;
            });
        });
    });
</script>
{% endblock %}