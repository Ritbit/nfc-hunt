{% extends "base.html" %}

{% block title %}
    {% if final %}Voyage Complete!{% else %}Clue Found!{% endif %} - Ocean Adventure
{% endblock %}

{% block head_styles %}
    {# Styles have been moved to ocean_adventure.css #}
{% endblock %}

{% block content %}
<div class="container">
    <h1>{% if final %}üéâ Voyage Complete! üéâ{% else %}üó∫Ô∏è Clue Unlocked! üó∫Ô∏è{% endif %}</h1>
    <p>Explorer: <strong>{{ player_name }}</strong></p>
    <hr>


    {% if not final %}
        <div class="clue-text">{{ clue }}</div>
        <div id="scan-instructions">
            <p class="success-message">Your current objective is to figure out this clue and <b>find the next fish tag</b> to continue your deep sea journey!</p>
            <button id="scanButton" class="scan-button">Scan Next Clue</button>
            <p id="scanStatus" class="scan-status"></p>
        </div>
    {% else %}
        <h2>Congratulations! <br>You are a Master Ocean Explorer!</h2>
        
        {% if completion_time %}
            <p>Your official completion time is:</p>
            <p class="score-time">{{ completion_time }}</p>

            {% if player_rank %}
            <p class="rank-display">That puts you at rank <strong>#{{ player_rank }}</strong> on the leaderboard!</p>
            {% endif %}
        {% endif %}

        <p>
            <a href="{{ url_for('index') }}""      style="margin-top: 20px; display: inline-block;">Back to the surface</a> | 
            <a href="{{ url_for('leaderboard') }}" style="margin-top: 20px; display: inline-block;">View Full Leaderboard</a>
        </p>
    {% endif %}

</div>
{% endblock %}

{% block scripts %}
<script>
        // Progressive Enhancement for Web NFC
        document.addEventListener('DOMContentLoaded', () => {
            if ('NDEFReader' in window) {
                const scanButton = document.getElementById('scanButton');
                scanButton.style.display = 'inline-block';
                const scanStatus = document.getElementById('scanStatus');

                scanButton.addEventListener('click', async () => {
                    try {
                        const ndef = new NDEFReader();
                        scanStatus.textContent = "Ready to scan. Hold your phone near the next tag...";
                        await ndef.scan();
                        ndef.addEventListener('reading', ({ message }) => {
                            const textDecoder = new TextDecoder();
                            const tagId = textDecoder.decode(message.records[0].data);
                            scanStatus.textContent = `Tag "${tagId}" found! Navigating...`;
                            window.location.href = `/hunt/clue/${tagId}`;
                        });
                    } catch (error) {
                        scanStatus.textContent = `Scan failed: ${error}`;
                        console.error("Web NFC error:", error);
                    }
                });
            }
        });
</script>
{% endblock %}
